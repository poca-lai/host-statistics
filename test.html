<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>主持統計工具</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
textarea { width: 100%; height: 250px; font-size: 14px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; white-space: pre-line; }
th { background-color: #f4f4f4; }
button { padding: 8px 16px; margin-top: 10px; font-size: 14px; }
</style>
</head>
<body>

<h2>主持統計工具</h2>
<textarea id="inputText" placeholder="請貼入主持記錄文本"></textarea>
<br>
<button id="processButton">統計</button>
<br>
<button id="copyButton">複製結果</button>
<table>
  <thead>
    <tr>
      <th>主持統計</th>
      <th>排檔統計</th>
      <th>互動統計</th>
      <th>全麥統計</th>
      <th>收光統計</th>
      <th>找光統計</th>
      <th>下光統計</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="hostStats"></td>
      <td id="memberStats"></td>
      <td id="interactionStats"></td>
      <td id="fullStats"></td>
      <td id="highlightStats"></td>
      <td id="findlightStats"></td>
      <td id="downlightStats"></td>
    </tr>
  </tbody>
</table>

<!-- 載入 OpenCC-js -->
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/cn2t.min.js"></script>

<script>
// 名稱順序
const NAME_ORDER = [
    "恩在","遺忘","螢螢","阿俊","沐希","伊諾","媃媃","天天","菲婷","煙酒","拾壹","豬皮","雪魂",
    "慕語","肚肚","愛睏","雨滴","阿夜","暖歌","紫","羊毛","宋炫","地獄池","莎莎","小睏羊",
    "月兒","2咩","Je","神秘人","豚寶寶","續寫","乖寶","榛榛","Ro","球球","大熊","阡先生","南潯","33"
];

function removeEmoji(text) {
    return text.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, '');
}

function normalizeName(name) {
    name = name.replace(/[波卡:]/g, '')
               .replace(/[0.2]/g, '') 
               .replace(/[- ]/g, '')
               .replace(/[困睏]/g, '睏')
               .replace(/[瑩營莹]/g, '螢')
               .replace(/^紫心$/, '紫')
               .replace(/[可狼可奶]/g, '神秘人')
               .replace(/^阡阡$/, '阡先生')
               .replace(/＊/g, '*')
               .replace(/^俊俊$/, '阿俊')
               .replace(/\*/g, '');
    return name;
}

function extractCountAndAdd(stats, info) {
    info = info.trim();
    if (!info) return;
    let name, count;
    if (info.includes('*')) {
        [name, count] = info.split('*');
        name = normalizeName(name);
        stats[name] = (stats[name] || 0) + parseFloat(count.trim());
    } else {
        const match = info.match(/(\D*)(\d+(\.\d+)?)/);
        if (match) {
            name = normalizeName(match[1].trim());
            count = parseFloat(match[2].trim());
            stats[name] = (stats[name] || 0) + count;
        }
    }
}

function sortByName(stats) {
    const sorted = {};
    NAME_ORDER.forEach(name => {
        if (stats[name] !== undefined) sorted[name] = stats[name];
    });
    Object.keys(stats).forEach(name => {
        if (!NAME_ORDER.includes(name)) sorted[name] = stats[name];
    });
    return sorted;
}

function formatCategory(stat) {
    if (!stat || Object.keys(stat).length === 0) return '';
    const sorted = sortByName(stat);
    return Object.entries(sorted).map(([name, count]) => `${name}: ${count} 次`).join('\n');
}

function extractInfo(text) {
    const hostStats = {};
    const memberStats = {};
    const interactionStats = {};
    const downlightStats = {};
    const highlightStats = {};
    const findlightStats = {};
    const fullStats = {};

    const hostPattern = /- 主持：([^\n]+)/g;
    const timePattern = /- 主持(?:時間|Time|时间)：(\d+)-(\d+)/g;
    const memberPattern = /排[档檔]成[员員]：\n([^：]+(?:\n[^\n]+)*)/g;
    const interactionPattern = /- 互動：\n([^：]+(?:\n[^\n]+)*)/g;
    const downlightPattern = /- 下光：\n([^：]+(?:\n[^\n]+)*)/g;
    const highlightPattern = /- 收光：\n([^：]+(?:\n[^\n]+)*)/g;
    const findlightPattern = /- 找光：\n([^：]+(?:\n[^\n]+)*)/g;
    const fullPattern = /- 备注：\n([^：]+(?:\n[^\n]+)*)/g;

    const segments = text.split(/(?=日期：\d{4}年\d{1,2}月\d{1,2}日)/);

    segments.forEach(segment => {
        const hosts = Array.from(segment.matchAll(hostPattern)).map(m => normalizeName(m[1]));
        const times = Array.from(segment.matchAll(timePattern)).map(m => [parseInt(m[1],10), parseInt(m[2],10)]);

        hosts.forEach((host, i) => {
            let start = 0, end = 0;
            if (times[i]) { start = times[i][0]; end = times[i][1]; } 
            else { end = start + 2; }
            let hours = end - start; if (hours < 0) hours += 24;
            hostStats[host] = (hostStats[host] || 0) + hours;
        });

        Array.from(segment.matchAll(memberPattern)).forEach(m => m[1].split('\n').forEach(line => extractCountAndAdd(memberStats, line)));
        Array.from(segment.matchAll(interactionPattern)).forEach(m => m[1].split('\n').forEach(line => extractCountAndAdd(interactionStats, line)));
        Array.from(segment.matchAll(downlightPattern)).forEach(m => m[1].split('\n').forEach(line => extractCountAndAdd(downlightStats, line)));
        Array.from(segment.matchAll(highlightPattern)).forEach(m => m[1].split('\n').forEach(line => extractCountAndAdd(highlightStats, line)));
        Array.from(segment.matchAll(findlightPattern)).forEach(m => m[1].split('\n').forEach(line => extractCountAndAdd(findlightStats, line)));
        Array.from(segment.matchAll(fullPattern)).forEach(m => m[1].split('\n').forEach(line => {
            const fullMatch = line.match(/(全[麥麦]|全麥互動)(?:\*(\d+))?/);
            if(fullMatch){
                const count = fullMatch[2] ? parseInt(fullMatch[2],10) : 1;
                hosts.forEach(h => { fullStats[h] = (fullStats[h] || 0) + count; });
            }
        }));
    });

    return {
        '主持': hostStats,
        '排檔': memberStats,
        '互動': interactionStats,
        '全麥': fullStats,
        '收光': highlightStats,
        '找光': findlightStats,
        '下光': downlightStats
    };
}

document.getElementById('processButton').addEventListener('click', () => {
    let text = removeEmoji(document.getElementById('inputText').value);
    if (!text.trim()) return;

    // 簡繁統一轉繁體（OpenCC-js）
    if (typeof OpenCC !== 'undefined') {
        try {
            const converter = OpenCC.Converter({ from: 'cn', to: 't' });
            text = converter(text);
        } catch (e) {
            console.warn("OpenCC 轉換失敗，直接使用原文。", e);
        }
    }

    const stats = extractInfo(text);
    document.getElementById('hostStats').textContent = formatCategory(stats['主持']);
    document.getElementById('memberStats').textContent = formatCategory(stats['排檔']);
    document.getElementById('interactionStats').textContent = formatCategory(stats['互動']);
    document.getElementById('fullStats').textContent = formatCategory(stats['全麥']);
    document.getElementById('highlightStats').textContent = formatCategory(stats['收光']);
    document.getElementById('findlightStats').textContent = formatCategory(stats['找光']);
    document.getElementById('downlightStats').textContent = formatCategory(stats['下光']);
});
document.getElementById('copyButton').addEventListener('click', () => {
    const host = document.getElementById('hostStats').textContent;
    const member = document.getElementById('memberStats').textContent;
    const interaction = document.getElementById('interactionStats').textContent;
    const full = document.getElementById('fullStats').textContent;
    const highlight = document.getElementById('highlightStats').textContent;
    const findlight = document.getElementById('findlightStats').textContent;
    const downlight = document.getElementById('downlightStats').textContent;

    // 分行為陣列，取最大行數，方便對齊
    const cols = [host, member, interaction, full, highlight, findlight, downlight].map(col => col.split('\n'));
    const maxRows = Math.max(...cols.map(c => c.length));

    let output = '';
    for (let i = 0; i < maxRows; i++) {
        const row = cols.map(c => c[i] || '').join('\t'); // 用 tab 分隔欄位
        output += row + '\n';
    }

    // 複製到剪貼簿
    navigator.clipboard.writeText(output).then(() => {
        alert('結果已複製，可以直接貼到 Excel！');
    }).catch(err => {
        alert('複製失敗：' + err);
    });
});
</script>
</body>
</html>
